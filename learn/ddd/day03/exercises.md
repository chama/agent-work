# Day 3 演習: 境界づけられたコンテキスト（Bounded Context）

> **目的**: Bounded Context の概念を自分の手で考え、描き、分析することで理解を深める
> **所要時間**: 各演習 30〜60分
> **準備するもの**: ノート（紙でもデジタルでもOK）、ペン

---

## 演習1: ECサイトの Bounded Context 分割

### 背景

あなたは、以下の要件を持つ ECサイト「FreshMart（フレッシュマート）」の設計を任されました。
このシステムをどのように Bounded Context に分割するか考えてください。

### 要件

FreshMart は生鮮食品のオンラインスーパーマーケットです。

**機能要件:**

1. **商品カタログ管理**
   - 商品の登録・編集・公開管理
   - カテゴリ分類（野菜、果物、肉、魚、乳製品、冷凍食品 等）
   - 商品画像の管理
   - 季節限定商品の管理
   - 価格の設定と変更

2. **在庫管理**
   - 倉庫ごとの在庫数量管理
   - 入荷・出荷の記録
   - 賞味期限の管理（生鮮食品特有）
   - 安全在庫割れのアラート
   - 廃棄管理（期限切れ商品の処理）

3. **注文処理**
   - カートへの商品追加
   - 注文の確定
   - 注文のキャンセル・変更
   - 定期注文（サブスクリプション）

4. **決済**
   - クレジットカード決済
   - コンビニ払い
   - ポイント利用
   - 返金処理

5. **配送**
   - 配送時間枠の管理（2時間刻み）
   - 冷蔵・冷凍・常温の温度帯管理
   - 配送ルート最適化
   - 不在時の再配達管理
   - 置き配対応

6. **顧客管理**
   - 会員登録・ログイン
   - お届け先住所の管理
   - アレルギー情報の管理
   - 購入履歴の閲覧

7. **マーケティング**
   - クーポンの発行・利用
   - ポイントプログラム
   - レコメンデーション（おすすめ商品）
   - メールマガジン配信

8. **カスタマーサポート**
   - 問い合わせ管理
   - 返品・交換対応
   - 配送トラブル対応

### 設問

#### 設問1-1: コンテキストの分割

上記の要件を読み、**最低5つの Bounded Context** を特定してください。
以下のフォーマットで回答してください。

```
┌──────────────────────────────────────────────────────────────┐
│ コンテキスト名:                                                │
│ 責務（このコンテキストが担当すること）:                            │
│ 主要なエンティティ/概念:                                       │
│ チーム規模の目安:                                              │
└──────────────────────────────────────────────────────────────┘
```

**回答例（1つ目を記入済み）:**

```
┌──────────────────────────────────────────────────────────────┐
│ コンテキスト名: カタログコンテキスト                               │
│ 責務: 商品情報の管理と顧客への表示                                │
│ 主要なエンティティ: Product, Category, Brand, Season             │
│ チーム規模の目安: 3-4人                                        │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│ コンテキスト名:                                                │
│ 責務:                                                        │
│ 主要なエンティティ:                                            │
│ チーム規模の目安:                                              │
└──────────────────────────────────────────────────────────────┘

（5つ以上記入してください）
```

#### 設問1-2: 分割の根拠

なぜそのように分割したのか、以下の観点から説明してください:

1. **言語の境界**: 同じ言葉が異なる意味を持つ箇所はどこか？
2. **変更の頻度と理由**: 異なるタイミング・理由で変更される機能はどれか？
3. **チーム独立性**: 各チームが独立して開発・デプロイできるか？

#### 設問1-3: 生鮮食品特有の考慮事項

一般的なECサイトと比較して、生鮮食品ECサイトの Bounded Context 分割で
特に考慮すべきポイントは何ですか？2つ以上挙げてください。

**ヒント**: 賞味期限、温度帯、廃棄管理 などのドメイン特有の概念に注目

---

## 演習2: コンテキストマップを描く

### 背景

以下は、ある企業の社内システム構成です。
各システム間の関係パターン（6パターンのいずれか）を特定してください。

### システム構成

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│                    社内システム構成図                          │
│                                                             │
│  ┌───────────────┐         ┌───────────────┐               │
│  │  A: 人事システム │         │  B: 給与システム │               │
│  │               │         │               │               │
│  │ 社員情報管理    │         │ 給与計算        │               │
│  │ 部署管理       │         │ 賞与計算        │               │
│  │ 入退社管理     │         │ 年末調整        │               │
│  └───────────────┘         └───────────────┘               │
│                                                             │
│  ┌───────────────┐         ┌───────────────┐               │
│  │  C: Salesforce │         │ D: 自社営業     │               │
│  │  (外部SaaS)   │         │   管理システム   │               │
│  │               │         │               │               │
│  │ 顧客管理(CRM) │         │ 案件管理        │               │
│  │ 商談管理       │         │ 見積作成        │               │
│  └───────────────┘         └───────────────┘               │
│                                                             │
│  ┌───────────────┐         ┌───────────────┐               │
│  │  E: 認証基盤   │         │  F: レガシー    │               │
│  │  (IdP)       │         │   会計システム   │               │
│  │               │         │               │               │
│  │ SSO           │         │ 仕訳管理        │               │
│  │ 権限管理       │         │ 決算処理        │               │
│  │ OAuth2/OIDC   │         │ （COBOL製）     │               │
│  └───────────────┘         └───────────────┘               │
│                                                             │
│  ┌───────────────┐         ┌───────────────┐               │
│  │ G: 物流システム │         │ H: 海外拠点    │               │
│  │               │         │   管理システム   │               │
│  │ 出荷管理       │         │               │               │
│  │ 在庫管理       │         │ 独自の会計      │               │
│  │ 配送追跡       │         │ 独自の人事      │               │
│  └───────────────┘         └───────────────┘               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 追加情報

| 関係 | 状況 |
|------|------|
| A → B | 人事システムと給与システムは同じチームが開発。社員情報の一部（社員番号、部署、等級）を共有コードとして持っている |
| C → D | Salesforce（外部SaaS）の顧客データを自社営業管理で利用。Salesforce のAPI仕様に合わせて実装している |
| D → F | 自社営業管理の売上データを、レガシー会計システムに連携。会計システムの独自フォーマットに変換して送信している。会計システム側は変更不可 |
| E → 全体 | 認証基盤はOAuth2/OIDCの標準プロトコルを公開。全システムが利用。個別システムの要求で仕様変更はしない |
| A → G | 人事システムの社員データ（配送担当者情報）を物流システムが利用。人事チームが物流チームの要求を聞いてAPIを提供 |
| H → 他 | 海外拠点は日本側と統合しないことを決定。独自に運用 |

### 設問

#### 設問2-1: 関係パターンの特定

上記の6つの関係それぞれについて、コンテキストマップの6パターン（Shared Kernel, Customer-Supplier, Conformist, ACL, Open Host Service / Published Language, Separate Ways）のいずれに該当するか特定してください。

| 関係 | パターン | 理由（1-2文） |
|------|---------|--------------|
| A ↔ B | | |
| C → D | | |
| D → F | | |
| E → 全体 | | |
| A → G | | |
| H ↔ 他 | | |

#### 設問2-2: コンテキストマップの図示

上記の分析結果をもとに、以下のテンプレートを使ってコンテキストマップを描いてください。
（ノートに手書き or テキストで描画）

```
コンテキストマップ

  [A: 人事] ──(???)── [B: 給与]

  [C: Salesforce] ──(???)── [D: 自社営業]

  [D: 自社営業] ──(???)── [F: 会計]

  [E: 認証] ──(???)── [全システム]

  [A: 人事] ──(???)── [G: 物流]

  [H: 海外] ──(???)── [他のシステム]

※ (???) にパターン名を記入
※ 矢印の方向（上流→下流）も明記
```

#### 設問2-3: 改善提案

もしあなたがこの企業のアーキテクトだとしたら、現在の構成で改善すべき点は何ですか？
特に以下の観点から1つ以上提案してください:

- Conformist パターンを ACL に変更すべき箇所はあるか？
- Separate Ways が適切でない箇所はあるか？
- 新しく統合すべき、または切り離すべき箇所はあるか？

---

## 演習3: 用語の多義性を分析する

### 背景

Bounded Context の重要なポイントは「同じ用語が異なるコンテキストで異なる意味を持つ」ことです。
この演習では、具体的な用語を分析し、コンテキストごとの違いを明確にします。

### 設問3-1: 「ユーザー」の多義性分析

以下のシステムにおける「ユーザー」という用語を、コンテキストごとに分析してください。

**システム**: オンライン学習プラットフォーム（Udemy のようなサービス）

以下の表を埋めてください:

| コンテキスト | 「ユーザー」の呼び方 | 主要な属性 | 主要な振る舞い | 関心事 |
|---|---|---|---|---|
| **認証** | Account（例） | email, password_hash, ... | login(), resetPassword(), ... | 本人確認 |
| **受講** | | | | |
| **講師管理** | | | | |
| **決済** | | | | |
| **サポート** | | | | |
| **マーケティング** | | | | |

### 設問3-2: 「コース」の多義性分析

同じシステムで「コース」という用語を分析してください。

| コンテキスト | 「コース」の呼び方 | 主要な属性 | 主要な振る舞い | 関心事 |
|---|---|---|---|---|
| **カタログ** | | | | |
| **受講** | | | | |
| **制作** | | | | |
| **決済** | | | | |
| **分析** | | | | |

### 設問3-3: あなたの業務ドメインで分析

あなたが現在関わっている（または過去に関わった）プロジェクトから1つの用語を選び、
同様の分析を行ってください。

**選んだ用語**: _______________

| コンテキスト | 呼び方 | 主要な属性 | 主要な振る舞い | 関心事 |
|---|---|---|---|---|
| | | | | |
| | | | | |
| | | | | |
| | | | | |

### 設問3-4: コンテキスト間の紐付け

設問3-1〜3-3で分析した用語について、異なるコンテキスト間で
どのように紐付けるか（どのようなIDを共有するか）を考えてください。

```
例:
  認証コンテキストの Account.id
    ↓ (user_id として共有)
  受講コンテキストの Learner.user_id
    ↓ (user_id として共有)
  決済コンテキストの Buyer.user_id

→ 各コンテキストは user_id だけを共有し、
  他のコンテキストのモデルを直接参照しない
```

あなたの分析した用語について、同様の紐付け図を描いてください。

---

## 発展課題（余力がある人向け）

### 発展課題A: Modular Monolith の設計

演習1で分割した FreshMart の Bounded Context を、
Python のパッケージ構成として設計してください。

```
freshmart/
├── catalog/          # カタログコンテキスト
│   ├── domain/       # ドメインモデル
│   ├── application/  # アプリケーションサービス
│   └── interface/    # インターフェース（API等）
├── inventory/        # 在庫コンテキスト
│   ├── domain/
│   ├── application/
│   └── interface/
├── ordering/         # 注文コンテキスト
│   └── ...
├── shared_kernel/    # 共有カーネル（最小限）
│   └── ...
└── ...
```

以下を定義してください:
1. 各コンテキストの `domain/` に含まれるエンティティと値オブジェクト
2. `shared_kernel/` に含めるもの（Money, ProductId 等の共有概念）
3. コンテキスト間の通信方法（メソッド呼び出し or イベント）

### 発展課題B: ACL の実装

`examples/anti_corruption_layer.py` を参考に、
以下のシナリオで Anti-Corruption Layer を実装してください:

**シナリオ**: あなたの新しい在庫管理システムは、
レガシーの倉庫管理システム（WMS: Warehouse Management System）から
在庫データを取得する必要がある。

レガシーWMSのデータ:
```python
# レガシーWMSの応答データ
{
    "ZAIKO_CD": "Z000123",          # 在庫コード
    "HINMOKU_CD": "H00456",         # 品目コード
    "SOUKO_CD": "S01",              # 倉庫コード
    "TANA_BANGO": "A-03-12",        # 棚番号
    "GENPIN_SU": 150,               # 現品数
    "HIKIATE_SU": 30,               # 引当数
    "YUUKO_SU": 120,                # 有効数（= 現品数 - 引当数）
    "SHOUMI_KIGEN": "20250401",     # 賞味期限
    "NYUUKA_YMD": "20250201",       # 入荷日
    "TANKA": 980,                   # 単価
    "KOUSHIN_NICHIJI": "2025-02-10 14:30:00",  # 更新日時
}
```

新しい在庫管理のドメインモデル:
```python
@dataclass
class InventoryItem:
    sku: str
    product_id: str
    available_quantity: int
    reserved_quantity: int
    warehouse: str
    location: str
    expiry_date: datetime
    unit_cost: Money
```

この変換を行う ACL（Translator + Adapter）を実装してください。

---

## 振り返りチェックリスト

本日の学習が完了したら、以下を確認してください:

- [ ] Bounded Context がなぜ必要か、自分の言葉で説明できる
- [ ] 同じ用語が異なるコンテキストで異なる意味を持つ例を3つ以上挙げられる
- [ ] コンテキストマップの6パターンをそれぞれ説明できる
- [ ] コンウェイの法則と Bounded Context の関係を説明できる
- [ ] 実際のシステムで Bounded Context の境界を見つけるヒューリスティクスを3つ以上知っている
- [ ] ACL がどのような場面で必要か説明できる

---

> **次のステップ**: 演習が完了したら、Day 4「集約（Aggregate）とドメインイベント」に進みましょう。
