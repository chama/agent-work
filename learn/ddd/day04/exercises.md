# Day 4 演習: サブドメインとコアドメイン

> **目的**: サブドメインの分類、Domain Vision Statement の作成、「作る vs 買う」の判断力を実践で身につける
> **所要時間**: 各演習 30〜60分
> **準備するもの**: ノート（紙でもデジタルでもOK）、ペン

---

## 演習1: フードデリバリーサービスのサブドメイン分類

### 背景

あなたは、新しいフードデリバリーサービス **「QuickBite（クイックバイト）」** のアーキテクトとして参画しました。このサービスのドメインをサブドメインに分類し、それぞれに適切な設計戦略を提案してください。

### QuickBite のサービス概要

QuickBite は、レストランの料理を素早くユーザーに届けるフードデリバリーサービスです。

**主な機能・領域:**

1. **配達員マッチング**: 注文に対して最適な配達員をリアルタイムに割り当てる
2. **ダイナミックプライシング**: 需要・天候・時間帯に応じて配達料を動的に変更する
3. **配達ルート最適化**: 複数の配達を効率的に処理するルート計算
4. **ETA予測**: 注文から配達完了までの時間を正確に予測する
5. **レストラン管理**: レストランの登録、メニュー管理、営業時間管理
6. **注文管理**: ユーザーからの注文受付、ステータス管理
7. **決済処理**: クレジットカード、電子マネー、ポイント利用
8. **ユーザー認証**: 会員登録、ログイン、パスワードリセット
9. **レビュー・評価**: レストランと配達員の評価システム
10. **プロモーション**: クーポン発行、初回割引、期間限定キャンペーン
11. **通知**: プッシュ通知、メール通知、SMS通知
12. **カスタマーサポート**: 問い合わせ対応、返金処理
13. **配達員管理**: 配達員の登録、審査、報酬計算
14. **分析・レポート**: 売上分析、配達パフォーマンス分析

### 設問

#### 設問1-1: サブドメインの分類

上記の14の機能・領域を、以下の3カテゴリに分類してください。

| # | 機能・領域 | 分類（Core / Supporting / Generic） | 分類の理由（1〜2文） |
|---|-----------|-----------------------------------|--------------------|
| 1 | 配達員マッチング | | |
| 2 | ダイナミックプライシング | | |
| 3 | 配達ルート最適化 | | |
| 4 | ETA予測 | | |
| 5 | レストラン管理 | | |
| 6 | 注文管理 | | |
| 7 | 決済処理 | | |
| 8 | ユーザー認証 | | |
| 9 | レビュー・評価 | | |
| 10 | プロモーション | | |
| 11 | 通知 | | |
| 12 | カスタマーサポート | | |
| 13 | 配達員管理 | | |
| 14 | 分析・レポート | | |

#### 設問1-2: 投資戦略の策定

分類結果をもとに、各サブドメインへの投資戦略を表にまとめてください。

```
┌──────────────────────────────────────────────────────────────┐
│ Core Domain                                                  │
│ 対象:                                                        │
│ 設計方針:                                                     │
│ 人材配置:                                                     │
│ 技術選定:                                                     │
│ テスト戦略:                                                   │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│ Supporting Subdomain                                         │
│ 対象:                                                        │
│ 設計方針:                                                     │
│ 人材配置:                                                     │
│ 技術選定:                                                     │
│ テスト戦略:                                                   │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│ Generic Subdomain                                            │
│ 対象:                                                        │
│ 設計方針:                                                     │
│ 人材配置:                                                     │
│ 技術選定:                                                     │
│ テスト戦略:                                                   │
└──────────────────────────────────────────────────────────────┘
```

#### 設問1-3: コアドメインの検証

以下の質問に答えて、自分の Core Domain の分類が正しいか検証してください:

1. 「もしこの機能が競合より劣っていたら、ユーザーは QuickBite を使わなくなるか？」
2. 「この機能は外部に委託しても問題ないか？」
3. 「この機能に最高のエンジニアを投入すべきか？」

### ヒント

<details>
<summary>💡 ヒントを見る（まず自分で考えてから開いてください）</summary>

**考え方のポイント:**

- フードデリバリーの本質は「早く・確実に届ける」こと
- 「この機能が壊れたら、QuickBite のビジネスが直接損なわれるか？」と自問する
- Uber Eats、出前館、menu などの競合と比較して「差別化の源泉」は何か？
- 決済や認証は重要だが、QuickBite 独自のものではない

**典型的な間違い:**
- 「決済は重要だからコアドメインだ」→ 重要性 ≠ 差別化要因
- 「すべてが重要に見える」→ コアは全体の20%程度に絞るべき

</details>

### 模範解答

<details>
<summary>📝 模範解答を見る</summary>

| # | 機能・領域 | 分類 | 理由 |
|---|-----------|------|------|
| 1 | 配達員マッチング | **Core** | 最適な配達員の割り当ては配達速度と品質に直結。競合との最大の差別化要因 |
| 2 | ダイナミックプライシング | **Core** | 需給バランスに応じた価格調整は、配達員の確保と収益最適化の要 |
| 3 | 配達ルート最適化 | **Core** | 複数配達の効率的な処理は配達時間短縮に直結。アルゴリズムが競争力 |
| 4 | ETA予測 | **Core** | 正確な時間予測はユーザー体験の核心。予測精度が顧客満足度を左右する |
| 5 | レストラン管理 | **Supporting** | コア機能を支えるが、メニュー管理自体はQuickBiteの差別化ではない |
| 6 | 注文管理 | **Supporting** | 注文の受付・追跡はサービスに不可欠だが、自社固有のロジックは限定的 |
| 7 | 決済処理 | **Generic** | どのデリバリーサービスでも必要。Stripe等の既製品で十分対応可能 |
| 8 | ユーザー認証 | **Generic** | 業界共通の機能。Auth0やFirebase Authで代替可能 |
| 9 | レビュー・評価 | **Supporting** | サービス品質の維持に重要だが、評価の仕組み自体は差別化要因ではない |
| 10 | プロモーション | **Supporting** | マーケティング施策をサポート。自社固有のルールはあるが差別化の核ではない |
| 11 | 通知 | **Generic** | プッシュ通知やメールは汎用機能。Firebase Cloud Messaging, SendGrid等で対応 |
| 12 | カスタマーサポート | **Generic** | Zendesk等のSaaSで対応可能。自社独自の仕組みは不要 |
| 13 | 配達員管理 | **Supporting** | 配達員の登録・審査は必要だが、差別化はマッチングアルゴリズム側にある |
| 14 | 分析・レポート | **Generic** | BI ツール（Looker, Tableau 等）で対応可能 |

**投資戦略の例:**

```
Core Domain（配達員マッチング、ダイナミックプライシング、ルート最適化、ETA予測）
  → リッチドメインモデル、最高のエンジニア配置
  → 徹底的なテスト（プロパティベーステスト含む）
  → 機械学習エンジニアとの協業
  → 絶対に外注しない

Supporting（レストラン管理、注文管理、レビュー、プロモーション、配達員管理）
  → シンプルなドメインモデルで十分
  → 中堅エンジニアが担当
  → 必要に応じてカスタマイズ
  → 一部は外注も検討可能

Generic（決済、認証、通知、カスタマーサポート、分析）
  → 既製品・SaaSを最大限活用
  → Stripe, Auth0, SendGrid, Zendesk, Looker 等
  → 自作しない、最小限のインテグレーションコードのみ
```

</details>

---

## 演習2: Domain Vision Statement を書く

### 背景

Domain Vision Statement は、コアドメインの目的と価値をチーム全員で共有するための短いドキュメントです。
この演習では、実際に Domain Vision Statement を書く練習をします。

### テンプレート

以下のテンプレートを使って、指定されたサービスの Domain Vision Statement を作成してください。

```markdown
# Domain Vision Statement: [サービス名]

## 我々のコアドメインは何か
[このソフトウェアが解決する中心的なビジネス課題を1〜2文で記述する]

## どのような価値を提供するか
[ユーザーやビジネスにとっての具体的な価値を記述する]

## 他社との差別化要因
[競合他社や代替ソリューションと比較して、何が独自なのかを明確にする]

## コアドメインの境界
含まれるもの:
- [要素1]
- [要素2]

含まれないもの:
- [要素1]
- [要素2]

## 成功の指標
- [指標1]
- [指標2]
```

### 設問

#### 設問2-1: QuickBite の Domain Vision Statement を書く

演習1で分類した QuickBite のコアドメインについて、Domain Vision Statement を作成してください。

**チェックポイント（書き終わったら確認）:**

- [ ] ビジネスの言葉で書かれているか？（技術用語を避ける）
- [ ] 1ページ以内に収まっているか？
- [ ] 「他社との違い」が明確か？
- [ ] コアドメインの境界が明確か？
- [ ] 測定可能な成功指標があるか？
- [ ] 非エンジニアも理解できるか？

#### 設問2-2: あなたの業務ドメインの Domain Vision Statement を書く

あなたが現在関わっている（または過去に関わった）プロジェクトについて、
Domain Vision Statement を作成してください。

**もし現在のプロジェクトがない場合は、以下のいずれかを選んでください:**

- オンライン学習プラットフォーム（Udemy のようなサービス）
- フリマアプリ（メルカリのようなサービス）
- 音楽ストリーミングサービス（Spotify のようなサービス）

### ヒント

<details>
<summary>💡 ヒントを見る</summary>

**書き方のコツ:**

1. **「なぜこのソフトウェアが存在するのか？」** から始める
2. **「競合他社のサービスと何が違うのか？」** を明確にする
3. **具体的な数字を入れる**: 「早い」ではなく「配達時間を平均15分短縮」
4. **技術用語を避ける**: 「機械学習アルゴリズム」ではなく「需要を予測する能力」
5. **含まれないもの**を明記する: これにより境界が明確になる

**よくある失敗:**
- 抽象的すぎる（「最高のユーザー体験を提供する」）
- 技術的すぎる（「GraphQL APIとKafkaイベントストリームを...」）
- 長すぎる（2ページ以上）
- 差別化要因がない（「安くて便利」）

</details>

### 模範解答

<details>
<summary>📝 QuickBite の模範解答を見る</summary>

```markdown
# Domain Vision Statement: QuickBite

## 我々のコアドメインは何か

QuickBite のコアドメインは「リアルタイム配達最適化」である。
注文が発生した瞬間から、最適な配達員を最適なルートで割り当て、
正確な到着時間を予測することで、業界最速の配達体験を実現する。

## どのような価値を提供するか

- ユーザーに対して: 「今すぐ届く」安心感と正確な待ち時間の提供
- レストランに対して: 料理が最も美味しい状態で届く配達品質
- 配達員に対して: 効率的なルートによる稼働時間あたりの収益最大化
- ビジネスに対して: 需給バランスに応じた価格設定による収益の最適化

## 他社との差別化要因

- 一般的なフードデリバリーが「近い配達員に割り当てる」だけなのに対し、
  QuickBite は配達員のスキル、現在の配達状況、交通情報、
  レストランの調理時間を統合的に考慮してマッチングを行う
- 天候・イベント・時間帯を考慮したダイナミックプライシングにより、
  ピーク時にも安定した配達員供給を実現する
- 複数注文の同時配達を最適化し、配達効率を競合比30%向上させる

## コアドメインの境界

含まれるもの:
- リアルタイム配達員マッチングエンジン
- ダイナミックプライシングエンジン
- マルチストップルート最適化
- ETA（到着時間）予測エンジン

含まれないもの:
- 決済処理（Stripe に委任）
- ユーザー認証（Auth0 に委任）
- 通知送信（Firebase Cloud Messaging に委任）
- レストランのメニュー管理（支援サブドメイン）

## 成功の指標

- 平均配達時間: 25分以内（業界平均35分）
- ETA予測精度: 実際の配達時間との誤差 ±3分以内
- 配達員稼働効率: 1時間あたり3件以上の配達完了
- ピーク時の配達員充足率: 95%以上
```

</details>

---

## 演習3: 「作る vs 買う vs 借りる」の判断演習

### 背景

ソフトウェアの各コンポーネントを「自社で作る（Build）」「購入する（Buy）」「借りる（Rent / SaaS）」のいずれかで調達する判断は、サブドメインの分類と密接に関連しています。

この演習では、複数のシナリオに対して適切な判断を下す練習をします。

### 判断フレームワーク（復習）

```
判断の手順:
  1. これは Core / Supporting / Generic のどれか？
  2. 市場に適切なソリューションがあるか？
  3. 自社固有のカスタマイズは必要か？
  4. データを外部に出せるか？
  5. 長期的な保守コストはどうか？
```

### 設問

以下の各シナリオについて、「作る」「買う」「借りる」のいずれかを選び、理由を述べてください。

#### シナリオ1: ECサイトの商品検索エンジン

```
状況:
- あなたの会社は大規模なECサイトを運営している
- 現在、商品検索は単純なキーワードマッチで実装されている
- 競合他社は「ユーザーの意図を理解した」高度な検索を提供している
- 商品検索の品質が売上に直結している
- エンジニアチームには検索アルゴリズムの専門家が2名いる

選択肢:
A. 自社で検索エンジンを構築する（Elasticsearch + 自社アルゴリズム）
B. Algolia（検索SaaS）を利用する
C. 商用検索エンジンのライセンスを購入する
```

あなたの判断: ___
理由:

---

#### シナリオ2: 社内の勤怠管理システム

```
状況:
- あなたの会社はIT企業（従業員300名）
- 現在は Excel で勤怠管理をしている
- 特殊な勤務体系はない（基本的に9-18時のオフィスワーク + リモートワーク）
- フレックスタイム制度がある（コアタイム 10-15時）
- 有給休暇の管理も必要

選択肢:
A. 自社で勤怠管理システムを構築する
B. freee 人事労務 や SmartHR を利用する（SaaS）
C. オンプレミスの勤怠管理パッケージを購入する
```

あなたの判断: ___
理由:

---

#### シナリオ3: フィンテック企業の不正検知システム

```
状況:
- あなたの会社はオンライン決済を提供するフィンテック企業
- 不正検知は「1ミリ秒でも速く、1件でも多く」検知することが求められる
- 不正検知の精度が企業の信頼性と直結している
- 競合他社は独自の機械学習モデルで不正検知率99.9%を実現している
- 年間数千万件のトランザクションを処理している

選択肢:
A. 自社で不正検知エンジンを構築する（機械学習モデル + ルールエンジン）
B. Sift Science（不正検知SaaS）を利用する
C. 商用の不正検知パッケージ（NICE Actimize等）を購入する
```

あなたの判断: ___
理由:

---

#### シナリオ4: スタートアップのメール配信機能

```
状況:
- あなたの会社は創業1年目のスタートアップ（エンジニア5名）
- ユーザーへのトランザクションメール（注文確認、パスワードリセット等）が必要
- マーケティングメール（ニュースレター等）も将来的に必要
- 月間送信数は現在1万通程度、1年後には10万通を見込む
- メール配信自体はビジネスの差別化要因ではない

選択肢:
A. 自社でメールサーバーを構築する（Postfix + 自社管理）
B. SendGrid / Amazon SES を利用する（SaaS）
C. メール配信パッケージを購入する（オンプレミス）
```

あなたの判断: ___
理由:

---

#### シナリオ5: 物流企業の配車最適化システム

```
状況:
- あなたの会社は大手物流企業
- 1日あたり数万件の配送を全国で処理している
- 配車の効率化が利益率に直結（燃料費、人件費の最適化）
- 現在は経験豊富なベテラン社員が手動で配車計画を立てている
- 競合他社はAIを活用した配車最適化で10%のコスト削減を実現している
- 自社の配送ネットワーク構造は業界内でもユニークである

選択肢:
A. 自社で配車最適化エンジンを構築する
B. 配車最適化SaaS（Optibus、Route4Me等）を利用する
C. 商用の配車最適化パッケージを購入してカスタマイズする
```

あなたの判断: ___
理由:

---

#### シナリオ6: Webアプリの認証機能

```
状況:
- あなたの会社はBtoBのSaaSを提供している
- ユーザー認証（ログイン、SSO、MFA）が必要
- 顧客企業はAzure AD や Google Workspace との SSO 連携を要求している
- セキュリティ要件は厳しいが、認証自体はビジネスの差別化ではない
- エンジニアチームにセキュリティの専門家はいない

選択肢:
A. 自社で認証システムを構築する（Passport.js / Spring Security 等）
B. Auth0 / Firebase Auth / Clerk を利用する（SaaS）
C. Keycloak をオンプレミスで運用する
```

あなたの判断: ___
理由:

### ヒント

<details>
<summary>💡 ヒントを見る</summary>

**判断のポイント:**

1. **サブドメインの種類を最初に判断する**
   - Core → 基本的に「作る」
   - Supporting → 「作る or カスタマイズして買う」
   - Generic → 「借りる（SaaS）」が第一選択

2. **「重要」と「差別化」を混同しない**
   - 認証は超重要だが、差別化要因ではない → Generic
   - 決済は超重要だが、（決済会社でない限り）差別化要因ではない → Generic

3. **チームのケイパビリティを考慮する**
   - 専門家がいるか？
   - 保守し続ける体力があるか？

4. **スタートアップ vs 大企業で判断が変わる**
   - スタートアップ: できるだけ SaaS を使い、コアに集中
   - 大企業: 規模とカスタマイズ要件に応じて買う/作るを選択

</details>

### 模範解答

<details>
<summary>📝 模範解答を見る</summary>

#### シナリオ1: ECサイトの商品検索エンジン → **A. 作る**

**理由:**
- 商品検索はECサイトのコアドメインに属する
- 売上に直結 = 競争優位性の源泉
- 専門家が社内にいるため技術的に実現可能
- 検索品質の差が競合との差別化に直結
- ただし、Elasticsearch の基盤は活用し、その上に自社のランキングアルゴリズムを構築するのが現実的

#### シナリオ2: 社内の勤怠管理 → **B. 借りる（SaaS）**

**理由:**
- 勤怠管理はどの企業にも共通の汎用サブドメイン（Generic）
- 特殊な勤務体系がないため、市販品で十分に対応可能
- IT企業のコアドメインは勤怠管理ではない
- freee 人事労務等は法改正への自動対応もしてくれるため、保守コストも下がる
- エンジニアリソースをコアドメインに集中させるべき

#### シナリオ3: フィンテック企業の不正検知 → **A. 作る**

**理由:**
- 不正検知はフィンテック企業のコアドメインそのもの
- 検知精度が企業の信頼性と存続に直結
- 競合が独自モデルで差別化しており、SaaSでは競争力を維持できない
- 大量のトランザクションデータは自社の学習データとして競争力の源泉
- 外部サービスに全トランザクションデータを送ることのリスクも大きい

#### シナリオ4: スタートアップのメール配信 → **B. 借りる（SaaS: SendGrid / Amazon SES）**

**理由:**
- メール配信は典型的な汎用サブドメイン（Generic）
- スタートアップの5名のエンジニアが自前のメールサーバーを運用するのは非効率
- 到達率、スパム対策、バウンス処理等は専門のSaaSに任せるべき
- 月額数千円〜で始められ、スケーラビリティも確保されている
- エンジニアリソースはビジネスの差別化に集中すべき

#### シナリオ5: 物流企業の配車最適化 → **A. 作る（一部 C. パッケージ活用も検討）**

**理由:**
- 配車最適化は物流企業のコアドメインに属する
- 自社の配送ネットワーク構造がユニークなため、汎用SaaSでは対応が難しい
- 配車効率が利益率に直結 = 競争優位性の源泉
- ただし、基盤となる最適化エンジン（OR Tools等のオープンソース）は活用し、その上に自社固有のロジックを構築するアプローチが現実的
- いきなり100%自作するのではなく、パッケージをベースにカスタマイズ（C）から始め、徐々に自社開発に移行する戦略もあり

#### シナリオ6: Webアプリの認証機能 → **B. 借りる（SaaS: Auth0 等）**

**理由:**
- 認証は典型的な汎用サブドメイン（Generic）
- SSO連携（Azure AD, Google Workspace）の実装は複雑だが、Auth0等なら標準対応
- チームにセキュリティ専門家がいないため、自社構築はリスクが高い
- 認証のセキュリティインシデントは事業に致命的な影響を与えうる
- BtoBのSaaS企業のコアドメインは認証ではなく、提供するサービスの本体

**判断のまとめ:**

| シナリオ | サブドメイン種別 | 判断 | 
|---------|---------------|------|
| 商品検索エンジン | Core | 作る |
| 勤怠管理 | Generic | 借りる |
| 不正検知 | Core | 作る |
| メール配信 | Generic | 借りる |
| 配車最適化 | Core | 作る |
| 認証機能 | Generic | 借りる |

</details>

---

## 振り返りチェックリスト

本日の演習が完了したら、以下を確認してください:

- [ ] サブドメインを Core / Supporting / Generic に分類する基準を自分の言葉で説明できる
- [ ] 「重要」と「差別化要因」の違いを理解している
- [ ] Domain Vision Statement を自分のプロジェクト用に書ける
- [ ] 「作る vs 買う vs 借りる」の判断を、サブドメインの種別から導き出せる
- [ ] コアドメインに最も多くのリソースを投入すべき理由を説明できる
- [ ] 汎用サブドメインを自作すべきでない理由を説明できる

---

## 発展課題（余力がある人向け）

### 発展課題A: サブドメインの変遷を考える

Uber のサブドメイン分類は創業当時と現在で変わっているはずです。
以下の2つの時期で、サブドメイン分類がどう変化したか考察してください。

- **2012年（創業初期）**: 黒塗りハイヤーの配車サービス
- **2024年（現在）**: ライドシェア、Uber Eats、Uber Freight、自動運転

**考察ポイント:**
- 創業初期の Core Domain は何だったか？
- 事業拡大に伴い、新たに Core になったものは何か？
- かつて Core だったものが Supporting に変わったものはあるか？
- → **コアドメインは固定ではなく、ビジネスの進化とともに変わる**

### 発展課題B: CQRS 適用判断

[examples/cqrs_overview.py](./examples/cqrs_overview.py) を読んだ上で、以下の質問に答えてください。

QuickBite の各サブドメインについて、CQRS を適用すべきか判断してください。

| サブドメイン | CQRS 適用？ | 理由 |
|-------------|-----------|------|
| 配達員マッチング | | |
| レストラン管理 | | |
| 注文管理 | | |
| 決済処理 | | |
| レビュー・評価 | | |

**判断基準:**
- 読み書きのパターンが大きく異なるか？
- 読み込みのパフォーマンスが特に重要か？
- モデルの複雑さが CQRS のコストを正当化するか？

---

> **次のステップ**: 演習が完了したら、Day 5「コンテキストマッピングパターン」に進みましょう。
